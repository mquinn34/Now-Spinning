{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <h2 class="vintage-font mb-4">Create a Spin</h2>

  <form method="POST" enctype="multipart/form-data" id="spinForm">
    {% csrf_token %}

    <!-- Search Artist -->
    <div class="mb-4 position-relative">
      <label for="artistInput" class="form-label">Search Artist</label>
      <input type="text" class="form-control" id="artistInput" placeholder="Start typing an artist..." autocomplete="off" aria-autocomplete="list" aria-controls="artistResults" aria-expanded="false">
      <ul class="list-group position-absolute w-100 mt-1 z-3" id="artistResults" role="listbox"></ul>
    </div>

    <!-- Album Dropdown -->
    <div class="mb-4 d-none" id="albumSearchSection">
      <label for="albumInput" class="form-label">Select Album</label>
      <!-- Dropdown by JavaScript -->
    </div>

    <!-- Preview -->
    <div class="mb-4 d-none" id="previewSection">
      <h5>Preview:</h5>
      <div class="d-flex align-items-start gap-3">
        <img id="albumCoverPreview" class="img-thumbnail" style="max-height: 160px;" alt="Album cover preview">
        <div>
          <h6 id="previewArtist" class="mb-1"></h6>
          <p id="previewAlbum" class="text-muted mb-0"></p>
        </div>
      </div>
    </div>

    <!-- Hidden Fields -->
    <input type="hidden" name="artist" id="hiddenArtist">
    <input type="hidden" name="album" id="hiddenAlbum">
    <input type="hidden" name="album_cover_url" id="hiddenCoverUrl">

    <!-- Caption -->
    <div class="mb-3">
      <label for="caption" class="form-label">Caption (optional)</label>
      <textarea class="form-control" name="caption" id="caption" rows="3"></textarea>
    </div>

    <!-- Photo -->
    <div class="mb-3">
      <label for="image" class="form-label">Your Record Photo (optional)</label>
      <input type="file" class="form-control" name="image" id="image" accept="image/*">
    </div>

    <button type="submit" class="btn btn-spin">Spin It</button>
  </form>
</div>

<style>
  #artistResults {
    max-height: 200px;
    overflow-y: auto;
  }
  
  .list-group-item.active-selection {
    background-color: var(--bs-primary);
    color: #fff;
  }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
  const artistInput = document.getElementById('artistInput');
  const artistResults = document.getElementById('artistResults');
  const albumSearchSection = document.getElementById('albumSearchSection');

  const previewSection = document.getElementById('previewSection');
  const hiddenArtist = document.getElementById('hiddenArtist');
  const hiddenAlbum = document.getElementById('hiddenAlbum');
  const hiddenCoverUrl = document.getElementById('hiddenCoverUrl');
  const previewArtist = document.getElementById('previewArtist');
  const previewAlbum = document.getElementById('previewAlbum');
  const albumCoverPreview = document.getElementById('albumCoverPreview');

  let selectedArtist = null;
  let debounceTimeout = null;
  let currentArtistController = null;
  let currentReleaseController = null;

  // simple debounce
  function debounce(fn, delay) {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(fn, delay);
  }

  function cancelController(ctrl) {
    if (ctrl) {
      try { ctrl.abort(); } catch(_) {}
    }
  }

  // Render artist suggestions
  function renderArtistResults(items) {
    artistResults.innerHTML = '';
    items.forEach((artist, idx) => {
      const li = document.createElement('li');
      li.className = 'list-group-item list-group-item-action';
      li.textContent = artist.title;
      li.setAttribute('role', 'option');
      li.setAttribute('data-id', artist.id);
      li.setAttribute('data-title', artist.title);
      li.addEventListener('click', () => chooseArtist(artist));
      artistResults.appendChild(li);
    });
    artistInput.setAttribute('aria-expanded', items.length > 0 ? 'true' : 'false');
  }

  async function searchArtists(query) {
    cancelController(currentArtistController);
    currentArtistController = new AbortController();
    try {
      const res = await fetch(`/api/discogs/artists?q=${encodeURIComponent(query)}`, {
        signal: currentArtistController.signal
      });
      if (!res.ok) {
        artistResults.innerHTML = '';
        return;
      }
      const data = await res.json();
      renderArtistResults((data && data.results) || []);
    } catch (_) {
      // aborted or network error
    }
  }

  // Choose an artist from the suggestions
  function chooseArtist(artist) {
    selectedArtist = artist;
    artistInput.value = artist.title;
    hiddenArtist.value = artist.title;
    artistResults.innerHTML = '';
    artistInput.setAttribute('aria-expanded', 'false');
    fetchAlbumsForArtist(artist.id, artist.title);
  }

  // Key navigation for suggestions
  let activeIndex = -1;
  artistInput.addEventListener('keydown', (e) => {
    const items = Array.from(artistResults.querySelectorAll('.list-group-item'));
    if (!items.length) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      activeIndex = (activeIndex + 1) % items.length;
      items.forEach(el => el.classList.remove('active-selection'));
      items[activeIndex].classList.add('active-selection');
      items[activeIndex].scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      activeIndex = (activeIndex - 1 + items.length) % items.length;
      items.forEach(el => el.classList.remove('active-selection'));
      items[activeIndex].classList.add('active-selection');
      items[activeIndex].scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'Enter') {
      if (activeIndex >= 0) {
        e.preventDefault();
        items[activeIndex].click();
      }
    } else if (e.key === 'Escape') {
      artistResults.innerHTML = '';
      activeIndex = -1;
      artistInput.setAttribute('aria-expanded', 'false');
    }
  });

  // Search Artist Autocomplete via backend
  artistInput.addEventListener('input', () => {
    debounce(() => {
      const query = artistInput.value.trim();
      artistResults.innerHTML = '';
      albumSearchSection.classList.add('d-none');
      previewSection.classList.add('d-none');
      selectedArtist = null;
      activeIndex = -1;

      if (query.length < 2) {
        artistInput.setAttribute('aria-expanded', 'false');
        return;
      }
      searchArtists(query);
    }, 300);
  });

  // Fetch Albums by artist id and create dropdown
  async function fetchAlbumsForArtist(artistId, artistTitle) {
    cancelController(currentReleaseController);
    currentReleaseController = new AbortController();

    try {
      const res = await fetch(`/api/discogs/artist/${artistId}/releases`, {
        signal: currentReleaseController.signal
      });
      if (!res.ok) {
        albumSearchSection.classList.add('d-none');
        return;
      }
      const data = await res.json();

      const select = document.createElement('select');
      select.className = 'form-select';
      select.id = 'albumInput';
      select.innerHTML = '<option value="">Select an album...</option>';

      for (const album of (data.results || [])) {
        const option = document.createElement('option');
        option.value = album.title || '';
        const label = album.year ? `${album.title} (${album.year})` : album.title;
        option.textContent = label || '';
        option.setAttribute('data-cover', album.thumb || '');
        select.appendChild(option);
      }

      albumSearchSection.innerHTML = `
        <label for="albumInput" class="form-label">Select Album</label>
      `;
      albumSearchSection.appendChild(select);
      albumSearchSection.classList.remove('d-none');

      select.addEventListener('change', () => {
        const selectedOption = select.options[select.selectedIndex];
        const albumTitle = selectedOption.value;
        const cover = selectedOption.getAttribute('data-cover');

        if (albumTitle) {
          hiddenAlbum.value = albumTitle;
          hiddenCoverUrl.value = cover || '';
          previewArtist.textContent = artistTitle;
          previewAlbum.textContent = albumTitle;
          albumCoverPreview.src = cover || '';
          previewSection.classList.remove('d-none');
        } else {
          previewSection.classList.add('d-none');
        }
      });
    } catch (_) {
      // aborted or network error
    }
  }
</script>
{% endblock %}
